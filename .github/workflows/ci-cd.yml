name: CI/CD Pipeline

on:
  push:
    branches: [ "main", "master" ]
  pull_request:
    branches: [ "main", "master" ]

jobs:
  build-and-test:
    name: Build and Run Tests
    runs-on: ubuntu-latest
    strategy:
      matrix:
        node-version: [18.x]

    steps:
    - name: Checkout repository
      uses: actions/checkout@v3

    - name: Setup Node.js
      uses: actions/setup-node@v3
      with:
        node-version: ${{ matrix.node-version }}

    # Backend
    - name: Install Backend Dependencies
      run: |
        cd backend
        npm install

    - name: Run Backend Tests
      run: |
        cd backend
        # Run tests if any, otherwise just echo
        if [ -f tests/sample.test.js ]; then npm test; else echo "No backend tests"; fi

    # Frontend
    - name: Install Frontend Dependencies
      run: |
        cd frontend
        npm install

    - name: Run Frontend Tests
      run: |
        cd frontend
        if [ -f src/App.test.js ]; then npm test -- --watchAll=false; else echo "No frontend tests"; fi

  deploy:
    name: Deploy to Azure
    needs: build-and-test
    runs-on: ubuntu-latest
    steps:
    - name: Checkout repository
      uses: actions/checkout@v3

    - name: Setup Node.js
      uses: actions/setup-node@v3
      with:
        node-version: '18.x'

    - name: Install Azure CLI
      uses: azure/setup-azure@v3

    - name: Build and Deploy
      env:
        AZURE_WEBAPP_NAME: Iv1201-test
        AZURE_RESOURCE_GROUP: Iv1201-test_group
      run: |
        # Build frontend
        cd frontend
        npm install
        npm run build

        # Copy build to backend
        cd ..
        rm -rf backend/public/*
        cp -r frontend/build/* backend/public/

        # Zip backend
        cd backend
        zip -r ../app.zip ./* -x "node_modules/*"

        # Fix backslashes for Azure
        cd ..
        unzip -o -q app.zip -d temp_extract
        cd temp_extract
        zip -r ../app_fixed.zip ./* -x "node_modules/*"
        cd ..
        rm -rf temp_extract
        mv app_fixed.zip app.zip

        # Deploy to Azure
        az webapp deploy --resource-group $AZURE_RESOURCE_GROUP --name $AZURE_WEBAPP_NAME --src-path app.zip --type zip
        echo "Deployment finished!"